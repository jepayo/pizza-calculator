<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Calculadora de Masa üçï</title>

  <style>
    body{
      margin:0; padding:16px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont;
      background:#fafafa; color:#111;
    }
    .card{
      max-width:560px; margin:auto;
      background:#fff; border-radius:16px;
      padding:16px; box-shadow:0 2px 14px rgba(0,0,0,.06);
    }
    header{ display:flex; justify-content:space-between; align-items:center; gap:12px; }
    h1{ font-size:1.2rem; margin:0; }

    /* Pizza */
    .pizza{ width:64px; animation:wobble 2.5s ease-in-out infinite; transform-origin:50% 60%; }
    @keyframes wobble{ 0%,100%{transform:rotate(-3deg)} 50%{transform:rotate(3deg)} }

    .controls{ margin-top:12px; }
    .control{ margin-bottom:14px; }
    .top{ display:flex; justify-content:space-between; font-weight:600; gap:10px; align-items:baseline; }
    input[type=range]{ width:100%; }
    .pill{ background:#eee; border-radius:999px; padding:4px 10px; font-variant-numeric:tabular-nums; white-space:nowrap; }

    .total{ margin-top:8px; font-weight:800; display:flex; justify-content:space-between; }

    .section{ margin-top:16px; font-weight:800; }
    .row{
      display:flex; justify-content:space-between;
      padding:6px 0; border-bottom:1px dashed #eee;
      font-variant-numeric:tabular-nums;
    }

    .note{
      margin-top:10px; padding:10px 12px;
      background:#f5f5f5; border-radius:12px;
      color:#333; font-weight:700; line-height: 1.25;
    }
    .note strong{ font-weight:900; }

    .tools{
      margin-top:10px;
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; flex-wrap:wrap;
    }
    .tools .left{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .tools label{
      display:flex; align-items:center; gap:8px;
      font-weight:800; user-select:none;
    }
    .tools input[type="checkbox"]{ transform: scale(1.2); }

    .btn{
      border:1px solid #ddd; background:#fff;
      border-radius:12px; padding:8px 10px;
      font-weight:900; cursor:pointer;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{ background:#111; color:#fff; border-color:#111; }
    .btn[disabled]{ opacity:.5; cursor:not-allowed; }

    .tiny{ margin-top:6px; color:#666; font-size:.86rem; font-weight:650; }

    details{ margin-top:16px; border:1px solid #eee; border-radius:14px; padding:8px; }
    summary{ font-weight:800; cursor:pointer; }
    .cfg{
      margin-top:10px;
      display:grid; grid-template-columns:1fr 1fr; gap:10px;
    }
    .cfg label{ font-size:.85rem; font-weight:800; }
    .cfg input{
      width:100%; padding:8px;
      border-radius:10px; border:1px solid #ccc;
      font-variant-numeric:tabular-nums;
    }
    button.save{
      margin-top:10px; padding:10px;
      border-radius:12px; border:none;
      font-weight:900; background:#111; color:#fff;
      width:100%; cursor:pointer;
    }

    /* Modal */
    .modalOverlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.35);
      display:none; align-items:center; justify-content:center;
      padding:16px; z-index:9999;
    }
    .modal{
      width:min(520px, 100%);
      background:#fff; border-radius:16px;
      padding:14px; box-shadow:0 8px 30px rgba(0,0,0,.25);
    }
    .modal h2{ margin:0 0 10px; font-size:1.05rem; }
    .modal .grid{ display:grid; gap:10px; }
    .modal input[type="datetime-local"]{
      width:100%;
      padding:10px;
      border-radius:12px;
      border:1px solid #ccc;
      font-size:1rem;
    }
    .modal .actions{
      display:flex; gap:10px; justify-content:flex-end; margin-top:10px; flex-wrap:wrap;
    }
  </style>
</head>

<body>
<div class="card">

<header>
  <h1>Calculadora de masa üçï</h1>
  <svg class="pizza" viewBox="0 0 120 120" aria-hidden="true">
    <path d="M22 20 L102 44 L60 108 Z" fill="#f7d48a" stroke="#d1a455" stroke-width="4"/>
    <path d="M22 20 C45 12, 80 18, 102 44" fill="none" stroke="#c7832c" stroke-width="12"/>
    <circle cx="60" cy="60" r="7" fill="#d6453d"/>
    <circle cx="70" cy="75" r="7" fill="#d6453d"/>
    <circle cx="50" cy="80" r="6" fill="#d6453d"/>
  </svg>
</header>

<div class="controls">
  <div class="control">
    <div class="top">
      <label for="pizzas">Pizzas</label>
      <span class="pill"><span id="pizzasVal">2</span></span>
    </div>
    <input id="pizzas" type="range" min="1" max="24" step="1" value="2">
  </div>

  <div class="control">
    <div class="top">
      <label for="gpp">Gramos por pizza</label>
      <span class="pill"><span id="gppVal">250</span> g</span>
    </div>
    <input id="gpp" type="range" min="150" max="300" step="5" value="250">
  </div>

  <div class="total">
    <span>Total</span>
    <span><span id="totalVal">0,00</span> g</span>
  </div>
</div>

<div class="section">Masa</div>
<div id="masa"></div>

<div class="tools">
  <div class="left">
    <label><input id="masaLock" type="checkbox"> Preparada (masa)</label>
    <button class="btn" id="masaEdit" type="button">Editar</button>
  </div>
  <button class="btn" id="masaReset" type="button">Reset</button>
</div>
<div id="masaTiny" class="tiny" style="display:none;"></div>
<div id="masaNote" class="note"></div>

<div class="section">Starter</div>
<div id="starter"></div>

<div class="tools">
  <div class="left">
    <label><input id="starterLock" type="checkbox"> Preparado (starter)</label>
    <button class="btn" id="starterEdit" type="button">Editar</button>
  </div>
  <button class="btn" id="starterReset" type="button">Reset</button>
</div>
<div id="starterTiny" class="tiny" style="display:none;"></div>
<div id="readyNote" class="note"></div>

<details>
  <summary>‚öôÔ∏è Configurar porcentajes</summary>
  <div class="cfg" id="cfg"></div>
  <button class="save" id="save">Guardar configuraci√≥n</button>
</details>

</div>

<!-- Modal -->
<div class="modalOverlay" id="modalOverlay" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <div class="modal">
    <h2 id="modalTitle">Editar fecha/hora</h2>
    <div class="grid">
      <div class="tiny" id="modalHint"></div>
      <input id="modalDatetime" type="datetime-local">
      <div class="actions">
        <button class="btn" id="modalCancel" type="button">Cancelar</button>
        <button class="btn primary" id="modalOk" type="button">Guardar</button>
      </div>
    </div>
  </div>
</div>

<script>
const DEC = 2;
const STORAGE_PCT = 'pizza_pct_v6';
const STORAGE_LOCK = 'pizza_locks_v2';
const MADRID_TZ = 'Europe/Madrid';
const STARTER_HOURS = 18;

const DEFAULTS = {
  harinaMasa:54.20,
  aguaMasa:33.60,
  levaduraMasa:0.27,
  salMasa:1.08,
  starterTotal:10.84,
  harinaStarter:5.2942,
  aguaStarter:5.2942,
  levaduraStarter:0.0135
};

let PCT = safeJSON(localStorage.getItem(STORAGE_PCT)) || {...DEFAULTS};
PCT = { ...DEFAULTS, ...PCT };

let LOCKS = safeJSON(localStorage.getItem(STORAGE_LOCK)) || {
  starter: { locked:false, preparedAt:null },
  masa: { locked:false, preparedAt:null }
};

const $ = id => document.getElementById(id);
const r = n => Number(n.toFixed(DEC));
const g = (t,p) => t * p / 100;

function safeJSON(s){ try{ return JSON.parse(s); }catch{ return null; } }
function savePct(){ localStorage.setItem(STORAGE_PCT, JSON.stringify(PCT)); }
function saveLocks(){ localStorage.setItem(STORAGE_LOCK, JSON.stringify(LOCKS)); }

function fmtNumber(n){ return r(n).toFixed(DEC).replace('.', ','); }
function row(label,val){
  return `<div class="row"><span>${label}</span><span>${fmtNumber(val)} g</span></div>`;
}

function fmtWeekdayAndDay(dateObj){
  const weekday = new Intl.DateTimeFormat('es-ES', { weekday:'long', timeZone: MADRID_TZ }).format(dateObj);
  const dayNum = new Intl.DateTimeFormat('es-ES', { day:'2-digit', timeZone: MADRID_TZ }).format(dateObj);
  return { weekday, dayNum };
}
function fmtTime(dateObj){
  return new Intl.DateTimeFormat('es-ES', {
    hour:'2-digit', minute:'2-digit', hour12:false, timeZone: MADRID_TZ
  }).format(dateObj);
}
function fmtDateTimeMadrid(dateObj){
  const { weekday, dayNum } = fmtWeekdayAndDay(dateObj);
  const time = fmtTime(dateObj);
  return `${weekday} ${dayNum} a las ${time}`;
}
function fmtPreparedSmall(dateObj){
  return `Preparad${isFemaleContext ? 'a' : 'o'} el ${fmtDateTimeMadrid(dateObj)}`;
}

// Helpers para ‚Äúready‚Äù
function starterReadyText(baseMs){
  const ready = new Date(baseMs + STARTER_HOURS * 60 * 60 * 1000);
  return `Estar√° listo el ${fmtDateTimeMadrid(ready)}`;
}
function starterReadyTextFromPrepared(baseMs){
  const ready = new Date(baseMs + STARTER_HOURS * 60 * 60 * 1000);
  return `Listo el ${fmtDateTimeMadrid(ready)}`;
}

function masaReadyHTML(baseMs){
  const d1 = new Date(baseMs + 1 * 24 * 60 * 60 * 1000);
  const d2 = new Date(baseMs + 2 * 24 * 60 * 60 * 1000);
  const a = fmtWeekdayAndDay(d1);
  const b = fmtWeekdayAndDay(d2);
  return `Estar√° lista el ${a.weekday} ${a.dayNum} ¬°o mejor!, el <strong>${b.weekday} ${b.dayNum}</strong>.`;
}
function masaReadyHTMLFromPrepared(baseMs){
  const d1 = new Date(baseMs + 1 * 24 * 60 * 60 * 1000);
  const d2 = new Date(baseMs + 2 * 24 * 60 * 60 * 1000);
  const a = fmtWeekdayAndDay(d1);
  const b = fmtWeekdayAndDay(d2);
  return `Lista el ${a.weekday} ${a.dayNum} ¬°o mejor!, el <strong>${b.weekday} ${b.dayNum}</strong>.`;
}

function computeTotal(){
  return Number($("pizzas").value) * Number($("gpp").value);
}

/* ----- Lock UI logic ----- */
function syncLockUI(){
  $("starterLock").checked = !!LOCKS.starter.locked;
  $("masaLock").checked = !!LOCKS.masa.locked;

  $("starterEdit").disabled = !LOCKS.starter.locked;
  $("masaEdit").disabled = !LOCKS.masa.locked;

  // Tiny ‚Äúpreparado el ‚Ä¶‚Äù
  if (LOCKS.starter.locked && LOCKS.starter.preparedAt){
    $("starterTiny").style.display = "block";
    $("starterTiny").textContent = `Preparado el ${fmtDateTimeMadrid(new Date(LOCKS.starter.preparedAt))}`;
  } else {
    $("starterTiny").style.display = "none";
    $("starterTiny").textContent = "";
  }

  if (LOCKS.masa.locked && LOCKS.masa.preparedAt){
    $("masaTiny").style.display = "block";
    $("masaTiny").textContent = `Preparada el ${fmtDateTimeMadrid(new Date(LOCKS.masa.preparedAt))}`;
  } else {
    $("masaTiny").style.display = "none";
    $("masaTiny").textContent = "";
  }
}

function buildConfig(){
  const cfg = $("cfg");
  cfg.innerHTML = '';
  const labels = {
    harinaMasa: 'harinaMasa (%)',
    aguaMasa: 'aguaMasa (%)',
    levaduraMasa: 'levaduraMasa (%)',
    salMasa: 'salMasa (%)',
    starterTotal: 'starterTotal (%)',
    harinaStarter: 'harinaStarter (%)',
    aguaStarter: 'aguaStarter (%)',
    levaduraStarter: 'levaduraStarter (%)'
  };

  for (const k in DEFAULTS){
    cfg.innerHTML += `
      <div>
        <label>${labels[k] || k}</label>
        <input data-k="${k}" type="number" step="0.0001" value="${PCT[k]}">
      </div>`;
  }
}

/* ----- Modal (datetime-local) ----- */
let modalContext = null; // "starter" | "masa"

function toDatetimeLocalValue(ms){
  // Usamos el timezone del dispositivo para el input. En tu caso ser√° Madrid.
  // Formato: YYYY-MM-DDTHH:MM
  const d = new Date(ms);
  const pad = (n) => String(n).padStart(2,'0');
  const yyyy = d.getFullYear();
  const mm = pad(d.getMonth()+1);
  const dd = pad(d.getDate());
  const hh = pad(d.getHours());
  const mi = pad(d.getMinutes());
  return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
}

function openModal(context){
  modalContext = context;
  const overlay = $("modalOverlay");
  const input = $("modalDatetime");
  const title = $("modalTitle");
  const hint = $("modalHint");

  const isStarter = context === "starter";
  title.textContent = isStarter ? "Editar (starter)" : "Editar (masa)";

  const baseMs = (LOCKS[context].preparedAt ?? Date.now());
  input.value = toDatetimeLocalValue(baseMs);

  hint.textContent = "Elige la fecha y hora en la que se prepar√≥. La disponibilidad se recalcular√° autom√°ticamente.";
  overlay.style.display = "flex";
}

function closeModal(){
  $("modalOverlay").style.display = "none";
  modalContext = null;
}

$("modalCancel").addEventListener("click", closeModal);
$("modalOverlay").addEventListener("click", (e) => {
  if (e.target.id === "modalOverlay") closeModal();
});
$("modalOk").addEventListener("click", () => {
  if (!modalContext) return;
  const val = $("modalDatetime").value; // "YYYY-MM-DDTHH:MM"
  const ms = Date.parse(val);
  if (!Number.isFinite(ms)) { closeModal(); return; }

  LOCKS[modalContext].locked = true;
  LOCKS[modalContext].preparedAt = ms;
  saveLocks();
  closeModal();
  calc();
});

/* ----- Main render ----- */
function calc(){
  const total = computeTotal();

  $("pizzasVal").textContent = $("pizzas").value;
  $("gppVal").textContent = $("gpp").value;
  $("totalVal").textContent = fmtNumber(total);

  $("masa").innerHTML = `
    ${row('Harina', g(total,PCT.harinaMasa))}
    ${row('Agua', g(total,PCT.aguaMasa))}
    ${row('Levadura', g(total,PCT.levaduraMasa))}
    ${row('Sal', g(total,PCT.salMasa))}
    ${row('Starter total', g(total,PCT.starterTotal))}
  `;

  $("starter").innerHTML = `
    ${row('Harina starter', g(total,PCT.harinaStarter))}
    ${row('Agua starter', g(total,PCT.aguaStarter))}
    ${row('Levadura starter', g(total,PCT.levaduraStarter))}
  `;

  const nowMs = Date.now();

  // Starter
  if (!LOCKS.starter.locked || !LOCKS.starter.preparedAt){
    $("readyNote").textContent = starterReadyText(nowMs);
  } else {
    $("readyNote").textContent = starterReadyTextFromPrepared(LOCKS.starter.preparedAt);
  }

  // Masa
  if (!LOCKS.masa.locked || !LOCKS.masa.preparedAt){
    $("masaNote").innerHTML = masaReadyHTML(nowMs);
  } else {
    $("masaNote").innerHTML = masaReadyHTMLFromPrepared(LOCKS.masa.preparedAt);
  }

  syncLockUI();
}

/* ----- Events ----- */
$("pizzas").addEventListener("input", calc);
$("gpp").addEventListener("input", calc);

// Config live
$("cfg").addEventListener("input", (e) => {
  const k = e.target?.dataset?.k;
  if (!k) return;
  PCT[k] = Number(e.target.value);
  calc();
});
$("save").addEventListener("click", savePct);

// Lock toggles: al marcar, fija "ahora"
$("starterLock").addEventListener("change", (e) => {
  if (e.target.checked){
    LOCKS.starter.locked = true;
    LOCKS.starter.preparedAt = Date.now();
  } else {
    LOCKS.starter.locked = false;
    LOCKS.starter.preparedAt = null;
  }
  saveLocks();
  calc();
});

$("masaLock").addEventListener("change", (e) => {
  if (e.target.checked){
    LOCKS.masa.locked = true;
    LOCKS.masa.preparedAt = Date.now();
  } else {
    LOCKS.masa.locked = false;
    LOCKS.masa.preparedAt = null;
  }
  saveLocks();
  calc();
});

// Edit
$("starterEdit").addEventListener("click", () => openModal("starter"));
$("masaEdit").addEventListener("click", () => openModal("masa"));

// Reset
$("starterReset").addEventListener("click", () => {
  LOCKS.starter = { locked:false, preparedAt:null };
  saveLocks();
  calc();
});
$("masaReset").addEventListener("click", () => {
  LOCKS.masa = { locked:false, preparedAt:null };
  saveLocks();
  calc();
});

// Tick cada minuto: solo si alguno est√° en modo ‚Äúno fijado‚Äù
setInterval(() => {
  const anyLive = (!LOCKS.starter.locked) || (!LOCKS.masa.locked);
  if (!anyLive) return;
  calc();
}, 60 * 1000);

/* ----- Init ----- */
buildConfig();
calc();
</script>
</body>
</html>
