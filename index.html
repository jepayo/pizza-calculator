<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Calculadora de Masa üçï</title>

  <style>
    body{
      margin:0;
      padding:16px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont;
      background:#fafafa;
      color:#111;
    }
    .card{
      max-width:560px;
      margin:auto;
      background:#fff;
      border-radius:16px;
      padding:16px;
      box-shadow:0 2px 14px rgba(0,0,0,.06);
    }
    header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
    }
    h1{ font-size:1.2rem; margin:0; }

    /* Pizza */
    .pizza{
      width:64px;
      animation:wobble 2.5s ease-in-out infinite;
      transform-origin:50% 60%;
    }
    @keyframes wobble{
      0%,100%{transform:rotate(-3deg)}
      50%{transform:rotate(3deg)}
    }

    .controls{ margin-top:12px; }
    .control{ margin-bottom:14px; }
    .top{
      display:flex;
      justify-content:space-between;
      font-weight:600;
      gap:10px;
      align-items:baseline;
    }
    input[type=range]{ width:100%; }

    .pill{
      background:#eee;
      border-radius:999px;
      padding:4px 10px;
      font-variant-numeric:tabular-nums;
      white-space:nowrap;
    }

    .total{
      margin-top:8px;
      font-weight:800;
      display:flex;
      justify-content:space-between;
    }

    .section{
      margin-top:16px;
      font-weight:800;
    }
    .row{
      display:flex;
      justify-content:space-between;
      padding:6px 0;
      border-bottom:1px dashed #eee;
      font-variant-numeric:tabular-nums;
    }

    .note{
      margin-top:10px;
      padding:10px 12px;
      background:#f5f5f5;
      border-radius:12px;
      color:#333;
      font-weight:700;
      line-height: 1.25;
    }
    .note strong{ font-weight:900; }

    .note-tools{
      margin-top:10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .note-tools label{
      display:flex;
      align-items:center;
      gap:8px;
      font-weight:700;
      user-select:none;
    }
    .note-tools input[type="checkbox"]{
      transform: scale(1.2);
    }
    .btn{
      border:1px solid #ddd;
      background:#fff;
      border-radius:12px;
      padding:8px 10px;
      font-weight:800;
      cursor:pointer;
    }
    .btn:active{ transform: translateY(1px); }

    .tiny{
      margin-top:6px;
      color:#666;
      font-size:.86rem;
      font-weight:600;
    }

    details{
      margin-top:16px;
      border:1px solid #eee;
      border-radius:14px;
      padding:8px;
    }
    summary{
      font-weight:800;
      cursor:pointer;
    }

    .cfg{
      margin-top:10px;
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    .cfg label{ font-size:.85rem; font-weight:700; }
    .cfg input{
      width:100%;
      padding:8px;
      border-radius:10px;
      border:1px solid #ccc;
      font-variant-numeric:tabular-nums;
    }
    button.save{
      margin-top:10px;
      padding:10px;
      border-radius:12px;
      border:none;
      font-weight:800;
      background:#111;
      color:#fff;
      width:100%;
      cursor:pointer;
    }
  </style>
</head>

<body>
<div class="card">

<header>
  <h1>Calculadora de masa üçï</h1>
  <svg class="pizza" viewBox="0 0 120 120" aria-hidden="true">
    <path d="M22 20 L102 44 L60 108 Z" fill="#f7d48a" stroke="#d1a455" stroke-width="4"/>
    <path d="M22 20 C45 12, 80 18, 102 44" fill="none" stroke="#c7832c" stroke-width="12"/>
    <circle cx="60" cy="60" r="7" fill="#d6453d"/>
    <circle cx="70" cy="75" r="7" fill="#d6453d"/>
    <circle cx="50" cy="80" r="6" fill="#d6453d"/>
  </svg>
</header>

<div class="controls">
  <div class="control">
    <div class="top">
      <label for="pizzas">Pizzas</label>
      <span class="pill"><span id="pizzasVal">2</span></span>
    </div>
    <input id="pizzas" type="range" min="1" max="24" step="1" value="2">
  </div>

  <div class="control">
    <div class="top">
      <label for="gpp">Gramos por pizza</label>
      <span class="pill"><span id="gppVal">250</span> g</span>
    </div>
    <input id="gpp" type="range" min="150" max="300" step="5" value="250">
  </div>

  <div class="total">
    <span>Total</span>
    <span><span id="totalVal">0,00</span> g</span>
  </div>
</div>

<div class="section">Masa</div>
<div id="masa"></div>

<div class="note-tools">
  <label><input id="masaLock" type="checkbox"> Fijar (masa)</label>
  <button class="btn" id="masaReset" type="button">Reset</button>
</div>
<div id="masaTiny" class="tiny" style="display:none;"></div>

<!-- Nota masa +1/+2 d√≠as -->
<div id="masaNote" class="note"></div>

<div class="section">Starter</div>
<div id="starter"></div>

<div class="note-tools">
  <label><input id="starterLock" type="checkbox"> Fijar (starter)</label>
  <button class="btn" id="starterReset" type="button">Reset</button>
</div>
<div id="starterTiny" class="tiny" style="display:none;"></div>

<!-- Nota starter +18h -->
<div id="readyNote" class="note"></div>

<details>
  <summary>‚öôÔ∏è Configurar porcentajes</summary>
  <div class="cfg" id="cfg"></div>
  <button class="save" id="save">Guardar configuraci√≥n</button>
</details>

</div>

<script>
const DEC = 2;
const STORAGE_PCT = 'pizza_pct_v5';
const STORAGE_LOCK = 'pizza_locks_v1';
const MADRID_TZ = 'Europe/Madrid';
const STARTER_HOURS = 18;

const DEFAULTS = {
  harinaMasa:54.20,
  aguaMasa:33.60,
  levaduraMasa:0.27,
  salMasa:1.08,
  starterTotal:10.84,

  harinaStarter:5.2942,
  aguaStarter:5.2942,
  levaduraStarter:0.0135
};

let PCT = safeJSON(localStorage.getItem(STORAGE_PCT)) || {...DEFAULTS};
PCT = { ...DEFAULTS, ...PCT }; // merge

let LOCKS = safeJSON(localStorage.getItem(STORAGE_LOCK)) || {
  starter: { locked:false, preparedAt:null },
  masa: { locked:false, preparedAt:null }
};

// Helpers
const $ = id => document.getElementById(id);
const r = n => Number(n.toFixed(DEC));
const g = (t,p) => t * p / 100;

function safeJSON(s){
  try{ return JSON.parse(s); }catch{ return null; }
}
function fmtNumber(n){
  return r(n).toFixed(DEC).replace('.', ',');
}

function row(label,val){
  return `<div class="row"><span>${label}</span><span>${fmtNumber(val)} g</span></div>`;
}

function fmtWeekdayAndDay(dateObj){
  const weekday = new Intl.DateTimeFormat('es-ES', {
    weekday: 'long',
    timeZone: MADRID_TZ
  }).format(dateObj);

  const dayNum = new Intl.DateTimeFormat('es-ES', {
    day: '2-digit',
    timeZone: MADRID_TZ
  }).format(dateObj);

  return { weekday, dayNum };
}

function fmtDateTimeMadrid(dateObj){
  // "martes 20 a las 12:30"
  const { weekday, dayNum } = fmtWeekdayAndDay(dateObj);

  const time = new Intl.DateTimeFormat('es-ES', {
    hour: '2-digit',
    minute: '2-digit',
    hour12: false,
    timeZone: MADRID_TZ
  }).format(dateObj);

  return `${weekday} ${dayNum} a las ${time}`;
}

function fmtPreparedSmall(dateObj){
  // m√°s detalle: "Preparado el martes 20 a las 09:12"
  return `Preparado el ${fmtDateTimeMadrid(dateObj)}`;
}

function computeTotal(){
  return Number($("pizzas").value) * Number($("gpp").value);
}

// Textos ‚Äúready‚Äù
function starterReadyText(baseMs){
  const ready = new Date(baseMs + STARTER_HOURS * 60 * 60 * 1000);
  return `Listo el ${fmtDateTimeMadrid(ready)}`;
}

function masaReadyHTML(baseMs){
  // ‚Äúnoches en nevera‚Äù: +1 y +2 d√≠as, sin horas
  const d1 = new Date(baseMs + 1 * 24 * 60 * 60 * 1000);
  const d2 = new Date(baseMs + 2 * 24 * 60 * 60 * 1000);
  const a = fmtWeekdayAndDay(d1);
  const b = fmtWeekdayAndDay(d2);
  return `Lista el ${a.weekday} ${a.dayNum} ¬°o mejor!, el <strong>${b.weekday} ${b.dayNum}</strong>.`;
}

// Persist locks
function saveLocks(){
  localStorage.setItem(STORAGE_LOCK, JSON.stringify(LOCKS));
}
function savePct(){
  localStorage.setItem(STORAGE_PCT, JSON.stringify(PCT));
}

// UI sync
function syncLockUI(){
  $("starterLock").checked = !!LOCKS.starter.locked;
  $("masaLock").checked = !!LOCKS.masa.locked;

  // tiny lines
  if (LOCKS.starter.locked && LOCKS.starter.preparedAt){
    $("starterTiny").style.display = "block";
    $("starterTiny").textContent = fmtPreparedSmall(new Date(LOCKS.starter.preparedAt));
  } else {
    $("starterTiny").style.display = "none";
    $("starterTiny").textContent = "";
  }

  if (LOCKS.masa.locked && LOCKS.masa.preparedAt){
    $("masaTiny").style.display = "block";
    $("masaTiny").textContent = fmtPreparedSmall(new Date(LOCKS.masa.preparedAt));
  } else {
    $("masaTiny").style.display = "none";
    $("masaTiny").textContent = "";
  }
}

function buildConfig(){
  const cfg = $("cfg");
  cfg.innerHTML = '';
  const labels = {
    harinaMasa: 'harinaMasa (%)',
    aguaMasa: 'aguaMasa (%)',
    levaduraMasa: 'levaduraMasa (%)',
    salMasa: 'salMasa (%)',
    starterTotal: 'starterTotal (%)',
    harinaStarter: 'harinaStarter (%)',
    aguaStarter: 'aguaStarter (%)',
    levaduraStarter: 'levaduraStarter (%)'
  };

  for (const k in DEFAULTS){
    cfg.innerHTML += `
      <div>
        <label>${labels[k] || k}</label>
        <input data-k="${k}" type="number" step="0.0001" value="${PCT[k]}">
      </div>`;
  }
}

function calc(){
  const total = computeTotal();

  $("pizzasVal").textContent = $("pizzas").value;
  $("gppVal").textContent = $("gpp").value;
  $("totalVal").textContent = fmtNumber(total);

  $("masa").innerHTML = `
    ${row('Harina', g(total,PCT.harinaMasa))}
    ${row('Agua', g(total,PCT.aguaMasa))}
    ${row('Levadura', g(total,PCT.levaduraMasa))}
    ${row('Sal', g(total,PCT.salMasa))}
    ${row('Starter total', g(total,PCT.starterTotal))}
  `;

  $("starter").innerHTML = `
    ${row('Harina starter', g(total,PCT.harinaStarter))}
    ${row('Agua starter', g(total,PCT.aguaStarter))}
    ${row('Levadura starter', g(total,PCT.levaduraStarter))}
  `;

  // Base para tiempos: ahora o fecha fijada
  const nowMs = Date.now();
  const starterBase = (LOCKS.starter.locked && LOCKS.starter.preparedAt) ? LOCKS.starter.preparedAt : nowMs;
  const masaBase = (LOCKS.masa.locked && LOCKS.masa.preparedAt) ? LOCKS.masa.preparedAt : nowMs;

  $("readyNote").textContent = starterReadyText(starterBase);
  $("masaNote").innerHTML = masaReadyHTML(masaBase);

  syncLockUI();
}

// Events
$("pizzas").addEventListener("input", calc);
$("gpp").addEventListener("input", calc);

// Config inputs live
$("cfg").addEventListener("input", (e) => {
  const k = e.target?.dataset?.k;
  if (!k) return;
  PCT[k] = Number(e.target.value);
  calc();
});

$("save").addEventListener("click", () => {
  savePct();
});

// Lock checkboxes
$("starterLock").addEventListener("change", (e) => {
  if (e.target.checked){
    LOCKS.starter.locked = true;
    LOCKS.starter.preparedAt = Date.now();
  } else {
    // si desmarcas, vuelve a modo live pero mantiene preparedAt por si luego quieres (opcional).
    LOCKS.starter.locked = false;
  }
  saveLocks();
  calc();
});

$("masaLock").addEventListener("change", (e) => {
  if (e.target.checked){
    LOCKS.masa.locked = true;
    LOCKS.masa.preparedAt = Date.now();
  } else {
    LOCKS.masa.locked = false;
  }
  saveLocks();
  calc();
});

// Reset buttons (borra todo y vuelve a live)
$("starterReset").addEventListener("click", () => {
  LOCKS.starter = { locked:false, preparedAt:null };
  saveLocks();
  calc();
});

$("masaReset").addEventListener("click", () => {
  LOCKS.masa = { locked:false, preparedAt:null };
  saveLocks();
  calc();
});

// Refresco cada minuto SOLO para las secciones no fijadas
setInterval(() => {
  const anyLive = (!LOCKS.starter.locked) || (!LOCKS.masa.locked);
  if (!anyLive) return;
  calc();
}, 60 * 1000);

// Init
buildConfig();
calc();
</script>
</body>
</html>
